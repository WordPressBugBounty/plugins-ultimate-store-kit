class USKGridVariations{constructor(t){this.$container=t,this.productId=t.data("product-id"),this.$swatchWrappers=t.find(".usk-variation-swatches__wrapper"),this.availableVariations=this.getAvailableVariations(),this.sequentialMode=!0===t.data("sequential"),this.currentStep=0,this.totalSteps=0,this.initContainer(),this.bindMethods(),this.setupEventListeners(),this.initActiveVariations(),this.updateAvailableAttributes(!0),this.sequentialMode&&this.setupSequentialMode(),jQuery(document.body).trigger("usk_grid_variations_init",this)}initContainer(){this.$container.off(".usk-grid-variations"),this.$swatchWrappers.length&&this.$container.addClass("swatches-support"),this.sequentialMode&&this.$container.addClass("usk-sequential-variations"),this.addResetButton(),this.sequentialMode&&this.addBackButton()}bindMethods(){this.getChosenAttributes=this.getChosenAttributes.bind(this),this.onSwatchSelect=this.onSwatchSelect.bind(this),this.onVariationButtonClick=this.onVariationButtonClick.bind(this),this.onKeyPress=this.onKeyPress.bind(this),this.onResetClick=this.onResetClick.bind(this),this.onBackClick=this.onBackClick.bind(this)}setupEventListeners(){this.$container.on("click.usk-grid-variations",".usk-variation-swatches__item",this.onSwatchSelect),this.$container.on("click.usk-grid-variations",".usk-variation-button",this.onVariationButtonClick),this.$container.on("keydown.usk-grid-variations",".usk-variation-swatches__item, .usk-variation-button",this.onKeyPress),this.$container.on("click.usk-grid-variations",".usk-reset-variations",this.onResetClick),this.$container.on("click.usk-grid-variations",".usk-back-variation",this.onBackClick)}addResetButton(){if(0===this.$container.find(".usk-reset-variations").length){const t=jQuery('<button type="button" class="usk-reset-variations" aria-label="Reset">\n    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">\n      <path\n        stroke="currentColor"\n        stroke-linecap="round"\n        stroke-linejoin="round"\n        stroke-width="2"\n        d="M17.651 7.65a7.131 7.131 0 0 0-12.68 3.15M18.001 4v4h-4m-7.652 8.35a7.13 7.13 0 0 0 12.68-3.15M6 20v-4h4"\n      />\n    </svg>\n  </button>\n');t.insertAfter(this.$container.find(".usk-variation-group").last()),t.hide()}}addBackButton(){if(0===this.$container.find(".usk-back-variation").length){const t=jQuery('\n  <button type="button" class="usk-back-variation" aria-label="Go Back">\n    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">\n  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4"/>\n</svg>\n  </button>\n');t.insertAfter(this.$container.find(".usk-variation-group").first()),t.hide()}}setupSequentialMode(){this.totalSteps=this.$container.find(".usk-variation-group").length||this.$swatchWrappers.length,this.totalSteps>1&&(this.$container.find(".usk-variation-group").each((t,a)=>{jQuery(a).toggle(0===t)}),this.$swatchWrappers.each((t,a)=>{jQuery(a).toggle(0===t)})),this.currentStep=0}goToNextStep(){this.currentStep<this.totalSteps-1&&(this.currentStep++,this.$container.find(".usk-variation-group").each((t,a)=>{jQuery(a).toggle(t===this.currentStep)}),this.$swatchWrappers.each((t,a)=>{jQuery(a).toggle(t===this.currentStep)}),this.currentStep>0&&this.$container.find(".usk-back-variation").show())}goToPreviousStep(){this.currentStep>0&&(this.currentStep--,this.$container.find(".usk-variation-group").each((t,a)=>{jQuery(a).toggle(t===this.currentStep)}),this.$swatchWrappers.each((t,a)=>{jQuery(a).toggle(t===this.currentStep)}),0===this.currentStep&&this.$container.find(".usk-back-variation").hide())}onBackClick(t){t.preventDefault(),this.goToPreviousStep()}onResetClick(t){t.preventDefault(),this.$container.find(".usk-variation-swatches__item, .usk-variation-button").removeClass("selected active disabled").data("disabled",!1).attr("aria-pressed","false").attr("tabindex",0),this.resetDataAttributes(),this.resetAddToCartButton(),this.$container.find(".usk-reset-variations").hide(),this.removeVariationSummary(),this.$container.find(".usk-step-summary").remove(),this.sequentialMode&&this.resetSequentialMode(),this.updateAvailableAttributes(!0)}resetDataAttributes(){this.$container.find(".usk-variation-group").each((t,a)=>{const i=jQuery(a).find(".usk-variation-button").first();if(i.length){const t=i.data("attribute");t&&this.$container.removeData("selected-attribute_"+t)}}),this.$swatchWrappers.each((t,a)=>{const i=jQuery(a).data("attribute_name");i&&this.$container.removeData("selected-"+i)}),this.$container.removeData("variation-id")}resetAddToCartButton(){const t=this.$container.closest(".usk-item").find(".usk-button");if(!t.length)return;t.removeClass("product_type_variation add_to_cart_button ajax_add_to_cart").addClass("product_type_variable").removeAttr("data-variation_id").attr("href","javascript:void(0)");try{jQuery.each(t[0].attributes,(a,i)=>{i&&i.name&&0===i.name.indexOf("data-attribute_")&&t.removeAttr(i.name)})}catch(t){console.log("Error clearing button attributes:",t)}const a=t.find(".usk-icon-arrow-right-8").length?'Select options <i class="button-icon usk-icon-arrow-right-8"></i>':"Select options";t.html(a)}resetSequentialMode(){this.$container.find(".usk-back-variation").hide(),this.currentStep=0,this.$container.find(".usk-variation-group").each((t,a)=>{jQuery(a).toggle(0===t)}),this.$swatchWrappers.each((t,a)=>{jQuery(a).toggle(0===t)})}getAvailableVariations(){let t=this.$container.data("available_variations");return!t&&"undefined"!=typeof usk_vars&&usk_vars.ajax_url&&jQuery.ajax({url:usk_vars.ajax_url,type:"POST",async:!1,data:{action:"usk_get_available_variations",product_id:this.productId},success:a=>{a.success&&a.data&&(t=a.data,this.$container.data("available_variations",t))}}),t||[]}initActiveVariations(){let t=0;this.$container.find(".usk-variation-swatches__item.selected").each((a,i)=>{jQuery(i).trigger("click.usk-grid-variations"),t++}),this.$container.find(".usk-variation-button.active").each((a,i)=>{jQuery(i).trigger("click.usk-grid-variations"),t++}),0===t&&this.selectDefaultAttributes(),this.toggleResetButton()}selectDefaultAttributes(){const t=this.$container.data("default_attributes");if(t)for(const a in t)if(t.hasOwnProperty(a)){const i=t[a],e=this.$container.find(`.usk-variation-swatches__item[data-value="${i}"]`);if(e.length)e.trigger("click.usk-grid-variations");else{const t=this.$container.find(`.usk-variation-button[data-value="${i}"]`);t.length&&t.trigger("click.usk-grid-variations")}}}toggleResetButton(){const t=this.getChosenAttributes();this.$container.find(".usk-reset-variations").toggle(t.chosenCount>0)}onSwatchSelect(t){t.preventDefault();const a=jQuery(t.currentTarget);if(a.hasClass("disabled")||a.data("disabled"))return;const i=a.closest(".usk-variation-swatches__wrapper"),e=i.data("attribute_name"),s=a.data("value");i.find(".usk-variation-swatches__item").removeClass("selected").attr("aria-pressed","false"),a.addClass("selected").attr("aria-pressed","true"),this.$container.data("selected-"+e,s),this.updateAvailableAttributes(),this.toggleResetButton(),this.updateAddToCartButton(),this.sequentialMode&&this.currentStep<this.totalSteps-1&&this.goToNextStep()}onVariationButtonClick(t){t.preventDefault();const a=jQuery(t.currentTarget),i=a.data("attribute"),e=a.data("value");a.hasClass("disabled")||a.data("disabled")||(a.siblings(".usk-variation-button").removeClass("active"),a.addClass("active"),this.$container.data("selected-attribute_"+i,e),this.updateAvailableAttributes(),this.toggleResetButton(),this.updateAddToCartButton(),this.sequentialMode&&this.currentStep<this.totalSteps-1&&this.goToNextStep())}updateAvailableAttributes(t=!1){const a=this.getChosenAttributes(),i=a.data,e=this.availableVariations;if(e&&e.length){if(this.$container.find(".usk-variation-swatches__item, .usk-variation-button").removeClass("disabled").data("disabled",!1).attr("tabindex",0),t||!a.chosenCount)return this.$swatchWrappers.each((t,a)=>{const i=jQuery(a),s=i.data("attribute_name");i.find(".usk-variation-swatches__item").each((t,a)=>{const i=jQuery(a),r=i.data("value");let n=!1;for(let t=0;t<e.length;t++){const a=e[t];if(!(a&&a.attributes&&a.is_in_stock&&a.is_purchasable))continue;const i=a.attributes;if(""===i[s]||i[s]===r){n=!0;break}}n||i.addClass("disabled").data("disabled",!0).attr("tabindex",-1)})}),void this.$container.find(".usk-variation-group").each((t,a)=>{const i=jQuery(a),s="attribute_"+i.find(".usk-variation-button").first().data("attribute");i.find(".usk-variation-button").each((t,a)=>{const i=jQuery(a),r=i.data("value");let n=!1;for(let t=0;t<e.length;t++){const a=e[t];if(!(a&&a.attributes&&a.is_in_stock&&a.is_purchasable))continue;const i=a.attributes;if(""===i[s]||i[s]===r){n=!0;break}}n||i.addClass("disabled").data("disabled",!0).attr("tabindex",-1)})});this.$swatchWrappers.each((t,a)=>{const e=jQuery(a),s=e.data("attribute_name");e.find(".usk-variation-swatches__item").each((t,a)=>{const e=jQuery(a),r=e.data("value");this.isAttributeAvailable(s,r,i)||e.addClass("disabled").data("disabled",!0).attr("tabindex",-1)})}),this.$container.find(".usk-variation-group").each((t,a)=>{const e=jQuery(a),s="attribute_"+e.find(".usk-variation-button").first().data("attribute");e.find(".usk-variation-button").each((t,a)=>{const e=jQuery(a),r=e.data("value");this.isAttributeAvailable(s,r,i)||e.addClass("disabled").data("disabled",!0).attr("tabindex",-1)})})}}isAttributeAvailable(t,a,i){const e=this.availableVariations;if(!t||!a||!i)return!0;if(!e||!e.length)return!0;const s={};for(const t in i)i.hasOwnProperty(t)&&""!==i[t]&&(s[t]=i[t]);s[t]=a;for(let t=0;t<e.length;t++){const a=e[t];if(!a||!a.attributes)continue;const i=a.attributes;let r=!0;for(const t in s)if(s.hasOwnProperty(t)){const a=s[t];if(void 0===i[t])continue;if(""===i[t])continue;if(i[t]!==a){r=!1;break}}if(r&&a.is_in_stock&&a.is_purchasable)return!0}return!1}onKeyPress(t){const a=t.keyCode&&32===t.keyCode||t.key&&" "===t.key,i=t.keyCode&&13===t.keyCode||t.key&&"enter"===t.key.toLowerCase();(a||i)&&(t.preventDefault(),jQuery(t.currentTarget).trigger("click.usk-grid-variations"))}updateProductImage(t){if(!t)return;const a=this.$container.closest(".usk-item"),i=a.find(".usk-image .img.image-default"),e=a.find(".usk-image .img.image-hover");i.length&&i.attr("src",t),e.length&&e.attr("src",t),i.attr("srcset")&&i.attr("srcset",""),e.attr("srcset")&&e.attr("srcset","")}updateAddToCartButton(){const t=this.$container.closest(".usk-item").find(".usk-button");if(!t.length)return;const a=this.getChosenAttributes();if(!a||a.chosenCount!==a.count)return void this.resetAddToCartToSelectOptions(t);const i=this.getTotalRequiredAttributes();a.chosenCount<i?this.resetAddToCartToSelectOptions(t):this.findMatchingVariation(a.data,(i,e)=>{this.$container.data("variation-id",i),i?(e&&e.image&&e.image.src&&this.updateProductImage(e.image.src),this.setAddToCartButton(t,i,a)):this.setUnavailableButton(t)})}resetAddToCartToSelectOptions(t){t.removeClass("product_type_variation add_to_cart_button ajax_add_to_cart").addClass("product_type_variable").removeAttr("data-variation_id").attr("href","javascript:void(0)"),this.clearButtonAttributes(t);const a=t.find(".usk-icon-arrow-right-8").length?'Select options <i class="button-icon usk-icon-arrow-right-8"></i>':"Select options";t.html(a),this.removeVariationSummary()}setUnavailableButton(t){t.removeClass("product_type_variation add_to_cart_button ajax_add_to_cart").addClass("product_type_variable").removeAttr("data-variation_id").attr("href","javascript:void(0)");const a=t.find(".usk-icon-arrow-right-8").length?'Unavailable <i class="button-icon usk-icon-arrow-right-8"></i>':"Unavailable";t.html(a),this.removeVariationSummary()}setAddToCartButton(t,a,i){this.clearButtonAttributes(t),t.removeClass("product_type_variable").addClass("product_type_variation add_to_cart_button ajax_add_to_cart").attr("data-product_id",this.productId).attr("data-variation_id",a).attr("data-prevent_redirect","true").attr("href","javascript:void(0)"),i.data&&jQuery.each(i.data,(a,i)=>{a&&i&&t.attr("data-"+a,i)});const e=t.find(".usk-icon-arrow-right-8").length?'Add to cart <i class="button-icon usk-icon-arrow-right-8"></i>':"Add to cart";t.html(e)}clearButtonAttributes(t){try{jQuery.each(t[0].attributes,(a,i)=>{i&&i.name&&0===i.name.indexOf("data-attribute_")&&t.removeAttr(i.name)})}catch(t){console.log("Error clearing attributes:",t)}}removeVariationSummary(){this.$container.find(".usk-variation-summary").remove()}findMatchingVariation(t,a){if(!t)return void a(null);const i=this.findMatchingVariationLocally(t);i?a(i.variation_id,i):this.findMatchingVariationOnServer(t,a)}findMatchingVariationLocally(t){const a=this.availableVariations;if(!a||!a.length)return null;for(let i=0;i<a.length;i++){const e=a[i];if(!e||!e.attributes)continue;const s=e.attributes;let r=!0;for(const a in t)if(t.hasOwnProperty(a)&&""!==t[a]){const i=t[a];if(void 0===s[a])continue;if(""===s[a])continue;if(s[a]!==i){r=!1;break}}if(r&&e.is_in_stock&&e.is_purchasable)return e}return null}findMatchingVariationOnServer(t,a){if("undefined"==typeof usk_vars||!usk_vars.ajax_url)return void a(null);const i={};for(const a in t)if(t.hasOwnProperty(a)&&t[a]){i[a.replace("attribute_","")]=t[a]}jQuery.ajax({url:usk_vars.ajax_url,type:"POST",data:{action:"usk_get_available_variations",product_id:this.productId,attributes:i,security:usk_vars.nonce||""},success:t=>{t&&t.success&&t.data?a(t.data.variation_id,t.data):a(null)},error:()=>{a(null)}})}getChosenAttributes(){const t={};let a=0,i=0;return this.$swatchWrappers&&this.$swatchWrappers.length&&this.$swatchWrappers.each((e,s)=>{const r=jQuery(s),n=r.data("attribute_name");if(!n)return!0;const o=r.find(".usk-variation-swatches__item.selected"),u=o.length?o.data("value"):"";u&&i++,a++,t[n]=u}),this.$container&&this.$container.find(".usk-variation-group").each((e,s)=>{const r=jQuery(s).find(".usk-variation-button.active");if(!r.length)return!0;const n=r.data("attribute");if(!n)return!0;const o="attribute_"+n,u=r.data("value")||"";t[o]||(u&&i++,a++,t[o]=u)}),{count:a,chosenCount:i,data:t}}getTotalRequiredAttributes(){let t=0;this.$swatchWrappers&&this.$swatchWrappers.length&&this.$swatchWrappers.each((a,i)=>{jQuery(i).data("attribute_name")&&t++});const a=new Set;return this.$swatchWrappers.each((t,i)=>{const e=jQuery(i).data("attribute_name");e&&a.add(e.replace("attribute_",""))}),this.$container.find(".usk-variation-group").each((i,e)=>{const s=jQuery(e).find(".usk-variation-button").first().data("attribute");s&&!a.has(s)&&t++}),t}}jQuery(function(t){function a(){t(".usk-variations-container:not(.swatches-support)").each(function(){new USKGridVariations(t(this))})}a(),t(document.body).on("wc_fragments_refreshed wc_fragments_loaded added_to_cart",a),t(document).ajaxComplete(function(t,i,e){setTimeout(function(){a()},100)})});